name: Deploy via SSH Keys

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies & build
        run: |
          npm ci
          npm run build

      - name: Create SSH key file
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 14.128.15.182 >> ~/.ssh/known_hosts

      - name: Deploy via RSYNC over SSH
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: 14.128.15.182
          REMOTE_USER: rhythmme
          TARGET: /home/rhythmme/public_html/
          SOURCE: ./
          EXCLUDE: "node_modules/, .git/, .github/, *.md, .env*"

      - name: Setup on server
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            rhythmme@14.128.15.182 << 'EOF'
            cd /home/rhythmme/public_html
            npm install --only=production
            # Restart with PM2 if installed
            pm2 restart all 2>/dev/null || echo "PM2 not found, manual restart needed"
            echo "âœ… Deployment complete!"
          EOF
