name: Next.js Deploy to cPanel (Rhythm Medical)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Define environment variables used throughout the job
    env:
      # --- Connection Details ---
      CPANEL_HOST: 14.128.15.182
      CPANEL_USER: rhythmme
      CPANEL_PORT: 22
      # --- Server Paths ---
      APP_ROOT: /home/rhythmme/public_html
      # CRITICAL: Verify this path from cPanel's "Setup Node.js App" page.
      NODE_VENV_SCRIPT: /home/rhythmme/nodevenv/nodevenv/public_html/20/bin/activate/20/bin/activate
      # --- Next.js Build Vars ---
      NEXT_PUBLIC_SITE_URL: https://rhythmmedicalint.com

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Local Build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: â¬‡ï¸ Install dependencies (Local Build)
        run: npm ci

      - name: ðŸ”¨ Build Next.js App (Local)
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: ðŸ§¹ Clean up Artifacts Before Transfer
        run: |
          # Cleanup is now even more important since rsync can be sensitive to files
          # This removes files that can cause transfer issues or are unnecessary
          find . -name '.DS_Store' -delete
          find . -name '*~' -delete
          rm -rf node_modules
          echo "Cleanup complete."

      # ----------------------------------------------------------------------
      # Step 1: Transfer all necessary files using rsync over SSH
      # ----------------------------------------------------------------------
      - name: â« Deploy Files via rsync over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}

          script: |
            rsync -avz --delete \
              --exclude='.git/' \
              --exclude='.github/' \
              --exclude='node_modules/' \
              --exclude='*.md' \
              --exclude='.env*' \
              --exclude='.eslintrc.json' \
              --exclude='.prettierrc' \
              --exclude='.prettierignore' \
              ./ ${{ env.CPANEL_USER }}@${{ env.CPANEL_HOST }}:${{ env.APP_ROOT }}
            echo "âœ… Files synchronized using rsync."

      - name: ðŸ”Ž Find Correct Node VENV Path
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}
          script: |
            echo "--- Scanning for 'activate' script in /home/${{ env.CPANEL_USER }}/nodevenv/ ---"
            # This command recursively searches the common Node.js VENV location
            find /home/${{ env.CPANEL_USER }}/nodevenv/ -name 'activate' 2>/dev/null
            echo "--- Scan Complete ---"
            echo "If the path is found, copy it and replace 'NODE_VENV_SCRIPT' in your YAML."

      # ----------------------------------------------------------------------
      # Step 2: SSH into the server to run commands and restart
      # ----------------------------------------------------------------------
      - name: ðŸ”„ Server Setup & Restart (cPanel VENV)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}
          script: |
            echo "--- Activating cPanel Node.js Environment ---"
            cd ${{ env.APP_ROOT }}

            # Activate the specific cPanel Node.js virtual environment
            if [ -f "${{ env.NODE_VENV_SCRIPT }}" ]; then
              source "${{ env.NODE_VENV_SCRIPT }}"
            else
              echo "âŒ ERROR: Node.js VENV script not found at ${{ env.NODE_VENV_SCRIPT }}"
              echo "Please verify the 'NODE_VENV_SCRIPT' environment variable is correct."
              exit 1
            fi

            echo "--- Installing Production Dependencies ---"
            npm install --only=production --no-audit --no-fund
            echo "âœ… Dependencies installed"

            echo "--- Triggering cPanel Phusion Passenger Restart ---"
            mkdir -p tmp
            touch tmp/restart.txt
            echo "âœ… Application restart signaled. Deployment complete."

            # Optional cleanup from previous attempts
            pm2 delete rhythm-medical-nextjs 2>/dev/null || true
