name: Next.js Deploy to cPanel (Rhythm Medical)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # --- Centralized Environment Variables ---
    env:
      # Connection Details
      CPANEL_HOST: 14.128.15.182
      CPANEL_USER: rhythmme
      CPANEL_PORT: 22
      # Server Paths
      APP_ROOT: /home/rhythmme/public_html
      # CRITICAL: PASTE YOUR VERIFIED VENV PATH HERE. E.g., /home/rhythmme/nodevenv/public_html/current/bin/activate
      NODE_VENV_SCRIPT: /home/rhythmme/nodevenv/nodevenv/public_html/20/bin/activate/20/bin/activate
      # Next.js Build Vars
      NEXT_PUBLIC_SITE_URL: https://rhythmmedicalint.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Local Build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: â¬‡ï¸ Install dependencies (Local Build)
        run: npm ci

      - name: ğŸ”¨ Build Next.js App (Local)
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: ğŸ§¹ Clean up Artifacts Before Transfer
        run: |
          find . -name '.DS_Store' -delete
          rm -rf node_modules
          echo "Cleanup complete."

      # ----------------------------------------------------------------------
      # Step 1: Transfer files using SCP-Action (Final attempt with optimized settings)
      # ----------------------------------------------------------------------
      - name: â« Deploy Files via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}

          source: "."
          target: ${{ env.APP_ROOT }}

          # Force clean transfer to prevent tar path errors
          rm: true # CRITICAL: Cleans the remote directory before transfer
          strip_components: 0 # CRITICAL: Prevents path stripping issues

          # Exclusions
          exclude: |
            .git
            .github
            node_modules
            *.md
            .env*
            .eslintrc.json
            .prettierrc
            .prettierignore
          overwrite: true

      # ----------------------------------------------------------------------
      # Step 2: SSH into the server to install dependencies and restart Phusion Passenger
      # ----------------------------------------------------------------------
      - name: ğŸ”„ Server Setup & Restart (cPanel VENV)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}
          script: |
            echo "--- Verifying Files on Server ---"
            cd ${{ env.APP_ROOT }} || { echo "âŒ ERROR: Target directory not found on server."; exit 1; }
            ls -al package.json || { echo "âŒ package.json NOT FOUND. SCP failed."; exit 1; }

            echo "--- Activating cPanel Node.js Environment ---"

            # --- VENV ACTIVATION (The critical step) ---
            if [ -f "${{ env.NODE_VENV_SCRIPT }}" ]; then
              source "${{ env.NODE_VENV_SCRIPT }}"
              echo "âœ… VENV Activated (Node.js version: $(node -v))"
            else
              echo "âŒ ERROR: Node.js VENV script not found at ${{ env.NODE_VENV_SCRIPT }}"
              exit 1
            fi

            echo "--- Installing Production Dependencies ---"
            npm install --only=production --no-audit --no-fund
            echo "âœ… Dependencies installed"

            echo "--- Triggering cPanel Phusion Passenger Restart ---"
            mkdir -p tmp
            touch tmp/restart.txt
            echo "âœ… Application restart signaled. Deployment complete."

            pm2 delete rhythm-medical-nextjs 2>/dev/null || true

      - name: âœ¨ Deployment Summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment Successful!"
          echo "========================"
          echo "ğŸŒ Website: ${{ env.NEXT_PUBLIC_SITE_URL }}"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”„ Triggered by: ${{ github.event_name }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message || 'Manual trigger' }}"
          echo "ğŸ‘¤ By: ${{ github.event.head_commit.author.name || 'N/A' }}"
