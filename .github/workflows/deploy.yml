name: Next.js Deploy to cPanel (Rhythm Medical)

on:
  push:
    branches: [main, master]
  # Allows manual triggering from the GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # --- Centralized Environment Variables ---
    env:
      # Connection Details
      CPANEL_HOST: 14.128.15.182
      CPANEL_USER: rhythmme
      CPANEL_PORT: 22
      # Server Paths
      APP_ROOT: /home/rhythmme/public_html
      # CRITICAL: REPLACE THIS PATH with the exact, verified Node VENV path from cPanel
      # Example: /home/rhythmme/nodevenv/public_html/current/bin/activate
      NODE_VENV_SCRIPT: /home/rhythmme/nodevenv/public_html/20/bin/activate
      # Next.js Build Vars
      NEXT_PUBLIC_SITE_URL: https://rhythmmedicalint.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Local Build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: â¬‡ï¸ Install dependencies (Local Build)
        run: npm ci

      - name: ğŸ”¨ Build Next.js App (Local)
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: ğŸ§¹ Clean up Artifacts Before Transfer
        run: |
          # Remove files that are unnecessary or can cause rsync/tar issues
          find . -name '.DS_Store' -delete
          find . -name '*~' -delete
          rm -rf node_modules
          echo "Cleanup complete."

      # ----------------------------------------------------------------------
      # Step 1: Transfer files using rsync over SSH (Robust transfer method)
      # ----------------------------------------------------------------------
      - name: â« Deploy Files via rsync over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}

          # rsync command for efficient, direct file synchronization
          script: |
            rsync -avz --delete \
              --exclude='.git/' \
              --exclude='.github/' \
              --exclude='node_modules/' \
              --exclude='*.md' \
              --exclude='.env*' \
              --exclude='.eslintrc.json' \
              --exclude='.prettierrc' \
              --exclude='.prettierignore' \
              ./ ${{ env.CPANEL_USER }}@${{ env.CPANEL_HOST }}:${{ env.APP_ROOT }}
            echo "âœ… Files synchronized using rsync."

      # ----------------------------------------------------------------------
      # Step 2: SSH into the server to install dependencies and restart Phusion Passenger
      # ----------------------------------------------------------------------
      - name: ğŸ”„ Server Setup & Restart (cPanel VENV)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}
          script: |
            echo "--- Activating cPanel Node.js Environment ---"
            cd ${{ env.APP_ROOT }}

            # --- VENV ACTIVATION (The critical step) ---
            if [ -f "${{ env.NODE_VENV_SCRIPT }}" ]; then
              source "${{ env.NODE_VENV_SCRIPT }}"
              echo "âœ… VENV Activated (Node.js version: $(node -v))"
            else
              echo "âŒ ERROR: Node.js VENV script not found at ${{ env.NODE_VENV_SCRIPT }}"
              echo "!!! STOP: Please verify the 'NODE_VENV_SCRIPT' environment variable is correct. !!!"
              exit 1
            fi

            echo "--- Installing Production Dependencies ---"
            npm install --only=production --no-audit --no-fund
            echo "âœ… Dependencies installed"

            echo "--- Triggering cPanel Phusion Passenger Restart ---"
            # This triggers the cPanel process manager to load the new app
            mkdir -p tmp
            touch tmp/restart.txt
            echo "âœ… Application restart signaled. Deployment complete."

            # Clean up old PM2 process if lingering from previous attempts
            pm2 delete rhythm-medical-nextjs 2>/dev/null || true

      - name: âœ¨ Deployment Summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment Successful!"
          echo "========================"
          echo "ğŸŒ Website: ${{ env.NEXT_PUBLIC_SITE_URL }}"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”„ Triggered by: ${{ github.event_name }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message || 'Manual trigger' }}"
          echo "ğŸ‘¤ By: ${{ github.event.head_commit.author.name || 'N/A' }}"
