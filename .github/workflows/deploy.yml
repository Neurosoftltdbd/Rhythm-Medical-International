name: Next.js Deploy to cPanel (Rhythm Medical)

on:
  push:
    branches: [main, master]
  # Allows you to trigger the workflow manually from the GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Define environment variables used throughout the job
    env:
      # --- Connection Details ---
      CPANEL_HOST: 14.128.15.182
      CPANEL_USER: rhythmme
      CPANEL_PORT: 22
      # --- Server Paths ---
      APP_ROOT: /home/rhythmme/public_html
      # CRITICAL: Replace '18' with your Node.js version if different (e.g., '20')
      # Get this exact path from your cPanel "Setup Node.js App" page.
      NODE_VENV_SCRIPT: /home/rhythmme/nodevenv/public_html/18/bin/activate
      # --- Next.js Build Vars ---
      NEXT_PUBLIC_SITE_URL: https://rhythmmedicalint.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (Local Build)
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: â¬‡ï¸ Install dependencies (Local Build)
        run: npm ci

      - name: ğŸ”¨ Build Next.js App (Local)
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      # ----------------------------------------------------------------------
      # Step 1: Transfer all necessary files to the server
      # ----------------------------------------------------------------------
      - name: â« Deploy Files via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}

          # Transfer the current directory (which now contains .next, public, package.json, etc.)
          source: "."
          target: ${{ env.APP_ROOT }}

          # Crucial: Prevent large directories or unnecessary files from being transferred
          exclude: |
            .git
            .github
            .vscode
            node_modules  # NEVER upload this; install on the server
            *.md
            .env*
            .eslintrc.json
            .prettierrc
            .prettierignore
          overwrite: true # Ensure new files replace old ones

      # ----------------------------------------------------------------------
      # Step 2: SSH into the server to run commands and restart
      # ----------------------------------------------------------------------
      - name: ğŸ”„ Server Setup & Restart (cPanel VENV)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.CPANEL_HOST }}
          username: ${{ env.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.CPANEL_PORT }}
          script: |
            echo "--- Activating cPanel Node.js Environment ---"
            cd ${{ env.APP_ROOT }}

            # Activate the specific cPanel Node.js virtual environment
            if [ -f "${{ env.NODE_VENV_SCRIPT }}" ]; then
              source "${{ env.NODE_VENV_SCRIPT }}"
            else
              echo "âŒ ERROR: Node.js VENV script not found at ${{ env.NODE_VENV_SCRIPT }}"
              echo "Please verify the 'NODE_VENV_SCRIPT' environment variable is correct."
              exit 1
            fi

            echo "--- Installing Production Dependencies ---"
            # Install only production dependencies for the Next.js runtime
            npm install --only=production --no-audit --no-fund
            echo "âœ… Dependencies installed"

            echo "--- Triggering cPanel Phusion Passenger Restart ---"
            # This is the standard way to restart a cPanel-managed Node.js application
            mkdir -p tmp
            touch tmp/restart.txt
            echo "âœ… Application restart signaled. Deployment complete."

            # Optional: Check PM2 status (if you still have it running from previous attempts)
            pm2 delete rhythm-medical-nextjs 2>/dev/null || echo "PM2 instance not found, clean."

      - name: âœ¨ Deployment Summary
        if: success()
        run: |
          echo "ğŸ‰ Deployment Successful!"
          echo "========================"
          echo "ğŸŒ Website: ${{ env.NEXT_PUBLIC_SITE_URL }}"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸ”„ Triggered by: ${{ github.event_name }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message || 'Manual trigger' }}"
          echo "ğŸ‘¤ By: ${{ github.event.head_commit.author.name || 'N/A' }}"
